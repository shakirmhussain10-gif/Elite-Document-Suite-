<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Image Tools by Muhammad Hussain Shakir | Elite Document Suite</title>
  <meta name="description" content="Free online image tools including resize, compress, crop, convert, background remover, OCR and more. Image Tools by Muhammad Hussain Shakir.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f3f4f6;
    }

    header {
      background: linear-gradient(135deg, #0f172a, #0ea5e9);
      color: white;
      padding: 30px 20px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 32px;
    }

    header p {
      margin-top: 8px;
      font-size: 16px;
      opacity: 0.9;
    }

    .container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
    }

    .section-title {
      margin: 40px 0 20px;
      font-size: 24px;
      color: #111827;
      border-left: 5px solid #0ea5e9;
      padding-left: 10px;
    }

    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
    }

    .tool-card {
      background: white;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.08);
      transition: 0.3s ease;
      cursor: pointer;
    }

    .tool-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }

    .tool-card h3 {
      margin: 0 0 10px;
      font-size: 18px;
      color: #0ea5e9;
    }

    .tool-card p {
      margin: 0;
      font-size: 14px;
      color: #555;
    }

    footer {
      text-align: center;
      padding: 25px;
      background: #0f172a;
      color: white;
      margin-top: 50px;
      font-size: 14px;
    }

    @media (max-width: 600px) {
      header h1 {
        font-size: 24px;
      }
    }

    /* Modal Overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }
    .modal-overlay.active { display: flex; justify-content: center; align-items: flex-start; }

    .modal-content {
      background: #fff;
      border-radius: 16px;
      max-width: 800px;
      width: 100%;
      margin: 40px auto;
      padding: 30px;
      position: relative;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-close {
      position: absolute;
      top: 15px; right: 20px;
      font-size: 28px;
      cursor: pointer;
      background: none;
      border: none;
      color: #333;
      line-height: 1;
    }
    .modal-close:hover { color: #e11d48; }

    .modal-content h2 {
      margin: 0 0 8px;
      color: #0f172a;
      font-size: 24px;
    }
    .modal-content .tool-desc {
      color: #666;
      margin-bottom: 20px;
      font-size: 14px;
    }

    /* Upload area */
    .upload-area {
      border: 2px dashed #0ea5e9;
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      background: #f0f9ff;
      transition: 0.2s;
      margin-bottom: 20px;
    }
    .upload-area:hover { background: #e0f2fe; }
    .upload-area.dragover { background: #bae6fd; border-color: #0284c7; }
    .upload-area p { margin: 0; color: #0284c7; font-size: 16px; }
    .upload-area input { display: none; }

    /* Controls */
    .controls { margin: 15px 0; }
    .controls label {
      display: block;
      margin: 8px 0 4px;
      font-weight: bold;
      font-size: 14px;
      color: #333;
    }
    .controls input[type="number"],
    .controls input[type="text"],
    .controls input[type="range"],
    .controls select,
    .controls textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
    }
    .controls input[type="range"] { padding: 4px 0; }
    .range-val { font-size: 13px; color: #666; margin-left: 8px; }

    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .row > * { flex: 1; min-width: 120px; }

    /* Buttons */
    .btn {
      display: inline-block;
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      transition: 0.2s;
      font-weight: bold;
    }
    .btn-primary { background: #0ea5e9; color: #fff; }
    .btn-primary:hover { background: #0284c7; }
    .btn-success { background: #22c55e; color: #fff; }
    .btn-success:hover { background: #16a34a; }
    .btn-danger { background: #ef4444; color: #fff; }
    .btn-danger:hover { background: #dc2626; }
    .btn-secondary { background: #6b7280; color: #fff; }
    .btn-secondary:hover { background: #4b5563; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin: 15px 0; }

    /* Preview */
    .preview-container {
      display: none;
      margin: 15px 0;
      text-align: center;
    }
    .preview-container.active { display: block; }
    .preview-container img, .preview-container canvas {
      max-width: 100%;
      max-height: 400px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .preview-label {
      font-size: 12px;
      color: #888;
      margin-top: 4px;
    }
    .previews-row {
      display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;
    }
    .previews-row > div { flex: 1; min-width: 200px; max-width: 380px; text-align: center; }

    /* Result info */
    .result-info {
      background: #f0fdf4;
      border: 1px solid #86efac;
      border-radius: 8px;
      padding: 12px 16px;
      margin: 12px 0;
      font-size: 14px;
      color: #166534;
      display: none;
    }
    .result-info.active { display: block; }

    /* Crop overlay */
    .crop-wrapper {
      position: relative;
      display: inline-block;
      max-width: 100%;
      margin: 10px 0;
    }
    .crop-wrapper img {
      max-width: 100%;
      display: block;
      border-radius: 8px;
    }
    .crop-selection {
      position: absolute;
      border: 2px dashed #0ea5e9;
      background: rgba(14,165,233,0.15);
      cursor: move;
    }

    /* OCR result */
    .ocr-result {
      background: #f9fafb;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 16px;
      white-space: pre-wrap;
      font-size: 14px;
      max-height: 300px;
      overflow-y: auto;
      margin: 12px 0;
      display: none;
    }
    .ocr-result.active { display: block; }

    /* Bulk list */
    .bulk-list {
      margin: 10px 0;
      max-height: 200px;
      overflow-y: auto;
    }
    .bulk-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 10px;
      background: #f9fafb;
      border-radius: 6px;
      margin: 4px 0;
      font-size: 13px;
    }
    .bulk-item img { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #0ea5e9;
      font-size: 16px;
    }
    .loading.active { display: block; }
    .spinner {
      display: inline-block;
      width: 24px; height: 24px;
      border: 3px solid #e5e7eb;
      border-top-color: #0ea5e9;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Text to image */
    .text-to-img-preview {
      border: 1px solid #d1d5db;
      border-radius: 8px;
      margin: 12px 0;
    }
  </style>
</head>
<body>

<nav style="display:flex;align-items:center;justify-content:space-between;padding:0 20px;height:48px;background:#0f172a;border-bottom:1px solid #1e293b;font-family:Arial,sans-serif;font-size:0.85rem;position:sticky;top:0;z-index:9999;">
  <a href="index.html" style="color:#38bdf8;font-weight:700;text-decoration:none;">Elite Document Suite</a>
  <div style="display:flex;gap:16px;">
    <a href="index.html" style="color:#94a3b8;text-decoration:none;">Home</a>
    <a href="about.html" style="color:#94a3b8;text-decoration:none;">About</a>
    <a href="contact.html" style="color:#94a3b8;text-decoration:none;">Contact</a>
    <a href="terms.html" style="color:#94a3b8;text-decoration:none;">Terms</a>
    <a href="privacy.html" style="color:#94a3b8;text-decoration:none;">Privacy</a>
  </div>
</nav>

<header>
  <h1>Image Tools</h1>
  <p>By Muhammad Hussain Shakir | Elite Document Suite</p>
</header>

<div class="container" id="mainContainer">

  <!-- BASIC IMAGE TOOLS -->
  <div class="section-title">Basic Image Tools</div>
  <div class="tools-grid">
    <div class="tool-card" onclick="openTool('resizer')"><h3>Image Resizer</h3><p>Resize images to custom width and height.</p></div>
    <div class="tool-card" onclick="openTool('compressor')"><h3>Image Compressor</h3><p>Reduce image file size without losing quality.</p></div>
    <div class="tool-card" onclick="openTool('cropper')"><h3>Image Cropper</h3><p>Crop images to desired dimensions.</p></div>
    <div class="tool-card" onclick="openTool('rotate')"><h3>Rotate Image</h3><p>Rotate image clockwise or anti-clockwise.</p></div>
    <div class="tool-card" onclick="openTool('flip')"><h3>Flip Image</h3><p>Flip image horizontally or vertically.</p></div>
    <div class="tool-card" onclick="openTool('jpg2png')"><h3>JPG to PNG</h3><p>Convert JPG images to PNG format.</p></div>
    <div class="tool-card" onclick="openTool('png2jpg')"><h3>PNG to JPG</h3><p>Convert PNG images to JPG format.</p></div>
    <div class="tool-card" onclick="openTool('towebp')"><h3>Convert to WebP</h3><p>Convert images into modern WebP format.</p></div>
    <div class="tool-card" onclick="openTool('webp2jpg')"><h3>WebP to JPG</h3><p>Convert WebP images back to JPG format.</p></div>
  </div>

  <!-- ADVANCED IMAGE TOOLS -->
  <div class="section-title">Advanced Image Tools</div>
  <div class="tools-grid">
    <div class="tool-card" onclick="openTool('bgremover')"><h3>Background Remover</h3><p>Remove image background automatically.</p></div>
    <div class="tool-card" onclick="openTool('bwfilter')"><h3>Black & White Filter</h3><p>Apply stunning monochrome effect.</p></div>
    <div class="tool-card" onclick="openTool('blur')"><h3>Blur Image</h3><p>Add blur effect to image.</p></div>
    <div class="tool-card" onclick="openTool('watermark')"><h3>Add Watermark</h3><p>Add custom watermark to images.</p></div>
    <div class="tool-card" onclick="openTool('ocr')"><h3>Image to Text (OCR)</h3><p>Extract text from images instantly.</p></div>
    <div class="tool-card" onclick="openTool('text2img')"><h3>Text to Image Generator</h3><p>Create image from custom text.</p></div>
    <div class="tool-card" onclick="openTool('bulkresize')"><h3>Bulk Image Resizer</h3><p>Resize multiple images at once.</p></div>
    <div class="tool-card" onclick="openTool('dpi')"><h3>Change Image DPI</h3><p>Modify image DPI settings easily.</p></div>
    <div class="tool-card" onclick="openTool('tosvg')"><h3>Convert Image to SVG</h3><p>Convert image into SVG format.</p></div>
  </div>

</div>

<!-- ==================== MODAL ==================== -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal-content" id="modalContent">
    <button class="modal-close" onclick="closeModal()">&times;</button>
    <div id="toolBody"></div>
  </div>
</div>

<footer>
  &copy; 2026 Image Tools by Muhammad Hussain Shakir | Elite Document Suite
</footer>

<!-- Tesseract.js for OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
// ============ UTILITY FUNCTIONS ============
function $(id) { return document.getElementById(id); }

function closeModal() {
  $('modalOverlay').classList.remove('active');
  document.body.style.overflow = '';
}

function openTool(toolId) {
  const body = $('toolBody');
  body.innerHTML = toolTemplates[toolId] ? toolTemplates[toolId]() : '<p>Tool not available.</p>';
  $('modalOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
  if (toolInit[toolId]) toolInit[toolId]();
}

$('modalOverlay').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

function createUploadArea(id, accept, multiple) {
  const multi = multiple ? 'multiple' : '';
  const acc = accept || 'image/*';
  return `
    <div class="upload-area" id="${id}Area" onclick="document.getElementById('${id}Input').click()">
      <p>Click or drag & drop to upload image${multiple ? 's' : ''}</p>
      <input type="file" id="${id}Input" accept="${acc}" ${multi}>
    </div>`;
}

function setupDragDrop(areaId, inputId, callback) {
  const area = $(areaId);
  const input = $(inputId);
  if (!area || !input) return;
  area.addEventListener('dragover', e => { e.preventDefault(); area.classList.add('dragover'); });
  area.addEventListener('dragleave', () => area.classList.remove('dragover'));
  area.addEventListener('drop', e => {
    e.preventDefault();
    area.classList.remove('dragover');
    input.files = e.dataTransfer.files;
    input.dispatchEvent(new Event('change'));
  });
  input.addEventListener('change', () => callback(input.files));
}

function loadImage(file) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}

function downloadCanvas(canvas, filename, type, quality) {
  canvas.toBlob(blob => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
  }, type || 'image/png', quality);
}

function downloadBlob(blob, filename) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / 1048576).toFixed(2) + ' MB';
}

function getExt(name) {
  return name.split('.').pop().toLowerCase();
}

function baseName(name) {
  return name.replace(/\.[^/.]+$/, '');
}

// ============ TOOL TEMPLATES ============
const toolTemplates = {};
const toolInit = {};

// ---- IMAGE RESIZER ----
toolTemplates.resizer = () => `
  <h2>Image Resizer</h2>
  <p class="tool-desc">Resize your image to any custom width and height.</p>
  ${createUploadArea('resizer', 'image/*')}
  <div class="preview-container" id="resizerPreview"></div>
  <div class="controls" id="resizerControls" style="display:none">
    <div class="row">
      <div><label>Width (px)</label><input type="number" id="resizeW" min="1" max="10000"></div>
      <div><label>Height (px)</label><input type="number" id="resizeH" min="1" max="10000"></div>
    </div>
    <label><input type="checkbox" id="resizeLock" checked> Maintain aspect ratio</label>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="doResize()">Resize</button>
      <button class="btn btn-success" id="resizerDl" style="display:none" onclick="dlResized()">Download</button>
    </div>
  </div>
  <div class="result-info" id="resizerInfo"></div>`;

toolInit.resizer = () => {
  let origImg = null, origRatio = 1, resultCanvas = null;
  window._resizer = {};
  setupDragDrop('resizerArea', 'resizerInput', async files => {
    if (!files[0]) return;
    origImg = await loadImage(files[0]);
    origRatio = origImg.width / origImg.height;
    $('resizerPreview').innerHTML = `<img src="${origImg.src}" style="max-height:250px"><div class="preview-label">Original: ${origImg.width} x ${origImg.height}</div>`;
    $('resizerPreview').classList.add('active');
    $('resizeW').value = origImg.width;
    $('resizeH').value = origImg.height;
    $('resizerControls').style.display = '';
    $('resizerDl').style.display = 'none';
    $('resizerInfo').classList.remove('active');
    window._resizer = { origImg, origRatio, file: files[0] };
  });

  document.addEventListener('input', function handler(e) {
    if (!window._resizer.origImg) return;
    if (e.target.id === 'resizeW' && $('resizeLock').checked) {
      $('resizeH').value = Math.round(parseInt($('resizeW').value) / window._resizer.origRatio) || '';
    }
    if (e.target.id === 'resizeH' && $('resizeLock').checked) {
      $('resizeW').value = Math.round(parseInt($('resizeH').value) * window._resizer.origRatio) || '';
    }
  });

  window.doResize = () => {
    const w = parseInt($('resizeW').value), h = parseInt($('resizeH').value);
    if (!w || !h || !window._resizer.origImg) return;
    const c = document.createElement('canvas');
    c.width = w; c.height = h;
    c.getContext('2d').drawImage(window._resizer.origImg, 0, 0, w, h);
    window._resizer.resultCanvas = c;
    $('resizerPreview').innerHTML = `<img src="${c.toDataURL()}" style="max-height:250px"><div class="preview-label">Resized: ${w} x ${h}</div>`;
    $('resizerDl').style.display = '';
    $('resizerInfo').textContent = `Resized from ${window._resizer.origImg.width}x${window._resizer.origImg.height} to ${w}x${h}`;
    $('resizerInfo').classList.add('active');
  };

  window.dlResized = () => {
    if (!window._resizer.resultCanvas) return;
    const ext = getExt(window._resizer.file.name);
    const type = ext === 'jpg' || ext === 'jpeg' ? 'image/jpeg' : ext === 'webp' ? 'image/webp' : 'image/png';
    downloadCanvas(window._resizer.resultCanvas, 'resized_' + window._resizer.file.name, type, 0.92);
  };
};

// ---- IMAGE COMPRESSOR ----
toolTemplates.compressor = () => `
  <h2>Image Compressor</h2>
  <p class="tool-desc">Reduce image file size by adjusting quality.</p>
  ${createUploadArea('compressor', 'image/*')}
  <div class="preview-container" id="compressorPreview"></div>
  <div class="controls" id="compressorControls" style="display:none">
    <label>Quality: <span id="compQVal">80</span>%</label>
    <input type="range" id="compQuality" min="1" max="100" value="80">
    <div class="btn-group">
      <button class="btn btn-primary" onclick="doCompress()">Compress</button>
      <button class="btn btn-success" id="compressorDl" style="display:none" onclick="dlCompressed()">Download</button>
    </div>
  </div>
  <div class="result-info" id="compressorInfo"></div>`;

toolInit.compressor = () => {
  window._comp = {};
  setupDragDrop('compressorArea', 'compressorInput', async files => {
    if (!files[0]) return;
    const img = await loadImage(files[0]);
    $('compressorPreview').innerHTML = `<img src="${img.src}" style="max-height:250px"><div class="preview-label">Original: ${formatSize(files[0].size)}</div>`;
    $('compressorPreview').classList.add('active');
    $('compressorControls').style.display = '';
    $('compressorDl').style.display = 'none';
    $('compressorInfo').classList.remove('active');
    window._comp = { img, file: files[0] };
  });

  document.addEventListener('input', function(e) {
    if (e.target.id === 'compQuality') $('compQVal').textContent = e.target.value;
  });

  window.doCompress = () => {
    const { img, file } = window._comp;
    if (!img) return;
    const q = parseInt($('compQuality').value) / 100;
    const c = document.createElement('canvas');
    c.width = img.width; c.height = img.height;
    c.getContext('2d').drawImage(img, 0, 0);
    c.toBlob(blob => {
      window._comp.blob = blob;
      window._comp.resultUrl = URL.createObjectURL(blob);
      $('compressorPreview').innerHTML = `<img src="${window._comp.resultUrl}" style="max-height:250px"><div class="preview-label">Compressed: ${formatSize(blob.size)}</div>`;
      $('compressorDl').style.display = '';
      const saved = ((1 - blob.size / file.size) * 100).toFixed(1);
      $('compressorInfo').innerHTML = `Original: ${formatSize(file.size)} &rarr; Compressed: ${formatSize(blob.size)} (${saved}% smaller)`;
      $('compressorInfo').classList.add('active');
    }, 'image/jpeg', q);
  };

  window.dlCompressed = () => {
    if (!window._comp.blob) return;
    downloadBlob(window._comp.blob, 'compressed_' + baseName(window._comp.file.name) + '.jpg');
  };
};

// ---- IMAGE CROPPER ----
toolTemplates.cropper = () => `
  <h2>Image Cropper</h2>
  <p class="tool-desc">Crop images by entering coordinates or dragging on the image.</p>
  ${createUploadArea('cropper', 'image/*')}
  <div id="cropperWorkspace" style="display:none">
    <div style="text-align:center;margin:10px 0">
      <canvas id="cropCanvas" style="max-width:100%;border-radius:8px;border:1px solid #e5e7eb;cursor:crosshair"></canvas>
    </div>
    <div class="controls">
      <div class="row">
        <div><label>X</label><input type="number" id="cropX" min="0" value="0"></div>
        <div><label>Y</label><input type="number" id="cropY" min="0" value="0"></div>
        <div><label>Width</label><input type="number" id="cropW" min="1"></div>
        <div><label>Height</label><input type="number" id="cropH" min="1"></div>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="doCrop()">Crop</button>
        <button class="btn btn-success" id="cropperDl" style="display:none" onclick="dlCropped()">Download</button>
      </div>
    </div>
    <div class="preview-container" id="cropResult"></div>
  </div>
  <div class="result-info" id="cropperInfo"></div>`;

toolInit.cropper = () => {
  window._crop = {};
  setupDragDrop('cropperArea', 'cropperInput', async files => {
    if (!files[0]) return;
    const img = await loadImage(files[0]);
    window._crop = { img, file: files[0], dragging: false, startX: 0, startY: 0 };

    const canvas = $('cropCanvas');
    const maxW = 700;
    const scale = img.width > maxW ? maxW / img.width : 1;
    canvas.width = img.width * scale;
    canvas.height = img.height * scale;
    window._crop.scale = scale;
    window._crop.displayW = canvas.width;
    window._crop.displayH = canvas.height;

    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    $('cropX').value = 0; $('cropY').value = 0;
    $('cropW').value = img.width; $('cropH').value = img.height;
    $('cropperWorkspace').style.display = '';
    $('cropperDl').style.display = 'none';
    $('cropResult').classList.remove('active');
    $('cropperInfo').classList.remove('active');

    // Mouse crop selection
    canvas.onmousedown = e => {
      const rect = canvas.getBoundingClientRect();
      window._crop.dragging = true;
      window._crop.startX = e.clientX - rect.left;
      window._crop.startY = e.clientY - rect.top;
    };
    canvas.onmousemove = e => {
      if (!window._crop.dragging) return;
      const rect = canvas.getBoundingClientRect();
      const cx = e.clientX - rect.left, cy = e.clientY - rect.top;
      const sx = window._crop.startX, sy = window._crop.startY;
      const x = Math.min(sx, cx), y = Math.min(sy, cy);
      const w = Math.abs(cx - sx), h = Math.abs(cy - sy);

      const ctx2 = canvas.getContext('2d');
      ctx2.clearRect(0, 0, canvas.width, canvas.height);
      ctx2.drawImage(img, 0, 0, canvas.width, canvas.height);
      ctx2.fillStyle = 'rgba(0,0,0,0.4)';
      ctx2.fillRect(0, 0, canvas.width, canvas.height);
      ctx2.clearRect(x, y, w, h);
      ctx2.drawImage(img, x / scale, y / scale, w / scale, h / scale, x, y, w, h);
      ctx2.strokeStyle = '#0ea5e9';
      ctx2.lineWidth = 2;
      ctx2.setLineDash([5, 3]);
      ctx2.strokeRect(x, y, w, h);
      ctx2.setLineDash([]);

      $('cropX').value = Math.round(x / scale);
      $('cropY').value = Math.round(y / scale);
      $('cropW').value = Math.round(w / scale);
      $('cropH').value = Math.round(h / scale);
    };
    canvas.onmouseup = () => { window._crop.dragging = false; };
    canvas.onmouseleave = () => { window._crop.dragging = false; };
  });

  window.doCrop = () => {
    const { img, file } = window._crop;
    if (!img) return;
    const x = parseInt($('cropX').value) || 0;
    const y = parseInt($('cropY').value) || 0;
    const w = parseInt($('cropW').value) || img.width;
    const h = parseInt($('cropH').value) || img.height;

    const c = document.createElement('canvas');
    c.width = w; c.height = h;
    c.getContext('2d').drawImage(img, x, y, w, h, 0, 0, w, h);
    window._crop.resultCanvas = c;

    $('cropResult').innerHTML = `<img src="${c.toDataURL()}" style="max-height:300px"><div class="preview-label">Cropped: ${w} x ${h}</div>`;
    $('cropResult').classList.add('active');
    $('cropperDl').style.display = '';
    $('cropperInfo').textContent = `Cropped to ${w}x${h} from position (${x}, ${y})`;
    $('cropperInfo').classList.add('active');
  };

  window.dlCropped = () => {
    if (!window._crop.resultCanvas) return;
    downloadCanvas(window._crop.resultCanvas, 'cropped_' + window._crop.file.name);
  };
};

// ---- ROTATE IMAGE ----
toolTemplates.rotate = () => `
  <h2>Rotate Image</h2>
  <p class="tool-desc">Rotate your image clockwise or counter-clockwise.</p>
  ${createUploadArea('rotate', 'image/*')}
  <div id="rotateWorkspace" style="display:none">
    <div class="preview-container active" id="rotatePreview"></div>
    <div class="controls">
      <div class="btn-group" style="justify-content:center">
        <button class="btn btn-primary" onclick="doRotate(-90)">&#8634; Rotate Left 90&deg;</button>
        <button class="btn btn-primary" onclick="doRotate(90)">&#8635; Rotate Right 90&deg;</button>
        <button class="btn btn-primary" onclick="doRotate(180)">Rotate 180&deg;</button>
      </div>
      <label>Custom angle: <input type="number" id="rotateAngle" value="0" style="width:80px;display:inline-block"> &deg;
        <button class="btn btn-secondary" onclick="doRotate(parseInt($('rotateAngle').value)||0)" style="margin-left:8px">Apply</button>
      </label>
      <div class="btn-group">
        <button class="btn btn-success" id="rotateDl" onclick="dlRotated()">Download</button>
      </div>
    </div>
  </div>
  <div class="result-info" id="rotateInfo"></div>`;

toolInit.rotate = () => {
  window._rotate = { totalAngle: 0 };
  setupDragDrop('rotateArea', 'rotateInput', async files => {
    if (!files[0]) return;
    const img = await loadImage(files[0]);
    window._rotate = { img, file: files[0], currentImg: img, totalAngle: 0 };
    $('rotatePreview').innerHTML = `<img src="${img.src}" style="max-height:300px"><div class="preview-label">Original</div>`;
    $('rotateWorkspace').style.display = '';
    $('rotateInfo').classList.remove('active');
  });

  window.doRotate = (angle) => {
    const { img } = window._rotate;
    if (!img) return;
    window._rotate.totalAngle = (window._rotate.totalAngle + angle) % 360;
    const rad = window._rotate.totalAngle * Math.PI / 180;
    const absS = Math.abs(Math.sin(rad)), absC = Math.abs(Math.cos(rad));
    const w = Math.round(img.width * absC + img.height * absS);
    const h = Math.round(img.width * absS + img.height * absC);

    const c = document.createElement('canvas');
    c.width = w; c.height = h;
    const ctx = c.getContext('2d');
    ctx.translate(w / 2, h / 2);
    ctx.rotate(rad);
    ctx.drawImage(img, -img.width / 2, -img.height / 2);
    window._rotate.resultCanvas = c;
    $('rotatePreview').innerHTML = `<img src="${c.toDataURL()}" style="max-height:300px"><div class="preview-label">Rotated ${window._rotate.totalAngle}&deg;</div>`;
    $('rotateInfo').textContent = `Image rotated by ${window._rotate.totalAngle}Â°`;
    $('rotateInfo').classList.add('active');
  };

  window.dlRotated = () => {
    const c = window._rotate.resultCanvas || (() => {
      const cv = document.createElement('canvas');
      cv.width = window._rotate.img.width; cv.height = window._rotate.img.height;
      cv.getContext('2d').drawImage(window._rotate.img, 0, 0);
      return cv;
    })();
    downloadCanvas(c, 'rotated_' + window._rotate.file.name);
  };
};

// ---- FLIP IMAGE ----
toolTemplates.flip = () => `
  <h2>Flip Image</h2>
  <p class="tool-desc">Flip your image horizontally or vertically.</p>
  ${createUploadArea('flip', 'image/*')}
  <div id="flipWorkspace" style="display:none">
    <div class="preview-container active" id="flipPreview"></div>
    <div class="controls">
      <div class="btn-group" style="justify-content:center">
        <button class="btn btn-primary" onclick="doFlip('h')">Flip Horizontal</button>
        <button class="btn btn-primary" onclick="doFlip('v')">Flip Vertical</button>
        <button class="btn btn-primary" onclick="doFlip('both')">Flip Both</button>
      </div>
      <div class="btn-group">
        <button class="btn btn-success" onclick="dlFlipped()">Download</button>
      </div>
    </div>
  </div>`;

toolInit.flip = () => {
  window._flip = { h: false, v: false };
  setupDragDrop('flipArea', 'flipInput', async files => {
    if (!files[0]) return;
    const img = await loadImage(files[0]);
    window._flip = { img, file: files[0], h: false, v: false };
    $('flipPreview').innerHTML = `<img src="${img.src}" style="max-height:300px"><div class="preview-label">Original</div>`;
    $('flipWorkspace').style.display = '';
  });

  window.doFlip = (dir) => {
    const { img } = window._flip;
    if (!img) return;
    if (dir === 'h') window._flip.h = !window._flip.h;
    if (dir === 'v') window._flip.v = !window._flip.v;
    if (dir === 'both') { window._flip.h = !window._flip.h; window._flip.v = !window._flip.v; }

    const c = document.createElement('canvas');
    c.width = img.width; c.height = img.height;
    const ctx = c.getContext('2d');
    ctx.translate(window._flip.h ? img.width : 0, window._flip.v ? img.height : 0);
    ctx.scale(window._flip.h ? -1 : 1, window._flip.v ? -1 : 1);
    ctx.drawImage(img, 0, 0);
    window._flip.resultCanvas = c;

    const label = [window._flip.h && 'Horizontal', window._flip.v && 'Vertical'].filter(Boolean).join(' + ') || 'Original';
    $('flipPreview').innerHTML = `<img src="${c.toDataURL()}" style="max-height:300px"><div class="preview-label">Flipped: ${label}</div>`;
  };

  window.dlFlipped = () => {
    const c = window._flip.resultCanvas;
    if (!c) return;
    downloadCanvas(c, 'flipped_' + window._flip.file.name);
  };
};

// ---- FORMAT CONVERTERS (JPG<->PNG, WebP) ----
function createConverter(id, title, desc, fromFmt, toFmt, toMime, toExt) {
  toolTemplates[id] = () => `
    <h2>${title}</h2>
    <p class="tool-desc">${desc}</p>
    ${createUploadArea(id, 'image/*')}
    <div class="preview-container" id="${id}Preview"></div>
    <div id="${id}Controls" style="display:none">
      ${toMime === 'image/jpeg' ? `<div class="controls"><label>Quality: <span id="${id}QVal">92</span>%</label><input type="range" id="${id}Quality" min="1" max="100" value="92" oninput="$('${id}QVal').textContent=this.value"></div>` : ''}
      <div class="btn-group">
        <button class="btn btn-primary" onclick="doConvert_${id}()">Convert</button>
        <button class="btn btn-success" id="${id}Dl" style="display:none" onclick="dlConvert_${id}()">Download</button>
      </div>
    </div>
    <div class="result-info" id="${id}Info"></div>`;

  toolInit[id] = () => {
    window['_' + id] = {};
    setupDragDrop(id + 'Area', id + 'Input', async files => {
      if (!files[0]) return;
      const img = await loadImage(files[0]);
      window['_' + id] = { img, file: files[0] };
      $(`${id}Preview`).innerHTML = `<img src="${img.src}" style="max-height:250px"><div class="preview-label">${files[0].name} (${formatSize(files[0].size)})</div>`;
      $(`${id}Preview`).classList.add('active');
      $(`${id}Controls`).style.display = '';
      $(`${id}Dl`).style.display = 'none';
      $(`${id}Info`).classList.remove('active');
    });

    window['doConvert_' + id] = () => {
      const data = window['_' + id];
      if (!data.img) return;
      const c = document.createElement('canvas');
      c.width = data.img.width; c.height = data.img.height;
      c.getContext('2d').drawImage(data.img, 0, 0);
      const q = $(`${id}Quality`) ? parseInt($(`${id}Quality`).value) / 100 : 0.92;
      c.toBlob(blob => {
        data.blob = blob;
        const url = URL.createObjectURL(blob);
        $(`${id}Preview`).innerHTML = `<img src="${url}" style="max-height:250px"><div class="preview-label">Converted ${toExt.toUpperCase()} (${formatSize(blob.size)})</div>`;
        $(`${id}Dl`).style.display = '';
        $(`${id}Info`).innerHTML = `Converted from ${getExt(data.file.name).toUpperCase()} to ${toExt.toUpperCase()} &mdash; Size: ${formatSize(blob.size)}`;
        $(`${id}Info`).classList.add('active');
      }, toMime, q);
    };

    window['dlConvert_' + id] = () => {
      const data = window['_' + id];
      if (!data.blob) return;
      downloadBlob(data.blob, baseName(data.file.name) + '.' + toExt);
    };
  };
}

createConverter('jpg2png', 'JPG to PNG', 'Convert JPG images to PNG format with transparency support.', 'jpg', 'png', 'image/png', 'png');
createConverter('png2jpg', 'PNG to JPG', 'Convert PNG images to JPG format for smaller file sizes.', 'png', 'jpg', 'image/jpeg', 'jpg');
createConverter('towebp', 'Convert to WebP', 'Convert images to modern WebP format for optimal web performance.', '*', 'webp', 'image/webp', 'webp');
createConverter('webp2jpg', 'WebP to JPG', 'Convert WebP images back to widely compatible JPG format.', 'webp', 'jpg', 'image/jpeg', 'jpg');

// ---- BACKGROUND REMOVER ----
toolTemplates.bgremover = () => `
  <h2>Background Remover</h2>
  <p class="tool-desc">Automatically remove image background. Works best with clear subjects.</p>
  ${createUploadArea('bgremover', 'image/*')}
  <div id="bgremoverWorkspace" style="display:none">
    <div class="controls">
      <label>Threshold sensitivity: <span id="bgThreshVal">30</span></label>
      <input type="range" id="bgThreshold" min="5" max="100" value="30" oninput="$('bgThreshVal').textContent=this.value">
      <label>Edge color to remove:</label>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="doBgRemove('auto')">Auto-detect</button>
        <button class="btn btn-secondary" onclick="doBgRemove('white')">White BG</button>
        <button class="btn btn-secondary" onclick="doBgRemove('black')">Black BG</button>
        <button class="btn btn-primary" onclick="doBgRemove('corners')">Corner Sample</button>
      </div>
    </div>
    <div class="preview-container active" id="bgremoverPreview"></div>
    <div class="btn-group">
      <button class="btn btn-success" id="bgremoverDl" style="display:none" onclick="dlBgRemoved()">Download PNG</button>
    </div>
  </div>
  <div class="result-info" id="bgremoverInfo"></div>`;

toolInit.bgremover = () => {
  window._bgr = {};
  setupDragDrop('bgremoverArea', 'bgremoverInput', async files => {
    if (!files[0]) return;
    const img = await loadImage(files[0]);
    window._bgr = { img, file: files[0] };
    $('bgremoverPreview').innerHTML = `<img src="${img.src}" style="max-height:300px"><div class="preview-label">Original</div>`;
    $('bgremoverWorkspace').style.display = '';
    $('bgremoverDl').style.display = 'none';
    $('bgremoverInfo').classList.remove('active');
  });

  window.doBgRemove = (mode) => {
    const { img } = window._bgr;
    if (!img) return;
    const c = document.createElement('canvas');
    c.width = img.width; c.height = img.height;
    const ctx = c.getContext('2d');
    ctx.drawImage(img, 0, 0);
    const imageData = ctx.getImageData(0, 0, c.width, c.height);
    const d = imageData.data;
    const threshold = parseInt($('bgThreshold').value);

    let bgR, bgG, bgB;
    if (mode === 'white') { bgR = 255; bgG = 255; bgB = 255; }
    else if (mode === 'black') { bgR = 0; bgG = 0; bgB = 0; }
    else {
      // Sample corners
      const samples = [
        [0, 0], [c.width - 1, 0], [0, c.height - 1], [c.width - 1, c.height - 1]
      ];
      let sr = 0, sg = 0, sb = 0;
      samples.forEach(([x, y]) => {
        const i = (y * c.width + x) * 4;
        sr += d[i]; sg += d[i + 1]; sb += d[i + 2];
      });
      bgR = Math.round(sr / 4); bgG = Math.round(sg / 4); bgB = Math.round(sb / 4);
    }

    for (let i = 0; i < d.length; i += 4) {
      const dist = Math.sqrt((d[i] - bgR) ** 2 + (d[i+1] - bgG) ** 2 + (d[i+2] - bgB) ** 2);
      if (dist < threshold * 4.42) {
        d[i + 3] = 0;
      } else if (dist < threshold * 6) {
        d[i + 3] = Math.min(255, Math.round((dist - threshold * 4.42) / (threshold * 1.58) * 255));
      }
    }

    ctx.putImageData(imageData, 0, 0);
    window._bgr.resultCanvas = c;

    const checker = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"><rect width="8" height="8" fill="#ccc"/><rect x="8" y="8" width="8" height="8" fill="#ccc"/><rect x="8" width="8" height="8" fill="#fff"/><rect y="8" width="8" height="8" fill="#fff"/></svg>');
    $('bgremoverPreview').innerHTML = `<div style="background:url('${checker}');display:inline-block;border-radius:8px"><img src="${c.toDataURL()}" style="max-height:300px;display:block"></div><div class="preview-label">Background Removed</div>`;
    $('bgremoverDl').style.display = '';
    $('bgremoverInfo').textContent = 'Background removed successfully. Download as PNG to preserve transparency.';
    $('bgremoverInfo').classList.add('active');
  };

  window.dlBgRemoved = () => {
    if (!window._bgr.resultCanvas) return;
    downloadCanvas(window._bgr.resultCanvas, 'nobg_' + baseName(window._bgr.file.name) + '.png', 'image/png');
  };
};

// ---- BLACK & WHITE FILTER ----
toolTemplates.bwfilter = () => `
  <h2>Black & White Filter</h2>
  <p class="tool-desc">Apply a monochrome effect to your image.</p>
  ${createUploadArea('bwfilter', 'image/*')}
  <div id="bwWorkspace" style="display:none">
    <div class="controls">
      <label>Method:</label>
      <select id="bwMethod">
        <option value="luminance">Luminance (Natural)</option>
        <option value="average">Average</option>
        <option value="desaturate">Desaturate</option>
        <option value="sepia">Sepia Tone</option>
      </select>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="doBW()">Apply Filter</button>
        <button class="btn btn-success" id="bwDl" style="display:none" onclick="dlBW()">Download</button>
      </div>
    </div>
    <div class="preview-container active" id="bwPreview"></div>
  </div>`;

toolInit.bwfilter = () => {
  window._bw = {};
  setupDragDrop('bwfilterArea', 'bwfilterInput', async files => {
    if (!files[0]) return;
    const img = await loadImage(files[0]);
    window._bw = { img, file: files[0] };
    $('bwPreview').innerHTML = `<img src="${img.src}" style="max-height:300px"><div class="preview-label">Original</div>`;
    $('bwWorkspace').style.display = '';
    $('bwDl').style.display = 'none';
  });

  window.doBW = () => {
    const { img } = window._bw;
    if (!img) return;
    const c = document.createElement('canvas');
    c.width = img.width; c.height = img.height;
    const ctx = c.getContext('2d');
    ctx.drawImage(img, 0, 0);
    const imageData = ctx.getImageData(0, 0, c.width, c.height);
    const d = imageData.data;
    const method = $('bwMethod').value;

    for (let i = 0; i < d.length; i += 4) {
      let r = d[i], g = d[i+1], b = d[i+2];
      if (method === 'luminance') {
        const gray = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
        d[i] = d[i+1] = d[i+2] = gray;
      } else if (method === 'average') {
        const gray = Math.round((r + g + b) / 3);
        d[i] = d[i+1] = d[i+2] = gray;
      } else if (method === 'desaturate') {
        const gray = Math.round((Math.max(r, g, b) + Math.min(r, g, b)) / 2);
        d[i] = d[i+1] = d[i+2] = gray;
      } else if (method === 'sepia') {
        d[i] = Math.min(255, Math.round(r * 0.393 + g * 0.769 + b * 0.189));
        d[i+1] = Math.min(255, Math.round(r * 0.349 + g * 0.686 + b * 0.168));
        d[i+2] = Math.min(255, Math.round(r * 0.272 + g * 0.534 + b * 0.131));
      }
    }
    ctx.putImageData(imageData, 0, 0);
    window._bw.resultCanvas = c;
    $('bwPreview').innerHTML = `<img src="${c.toDataURL()}" style="max-height:300px"><div class="preview-label">${$('bwMethod').selectedOptions[0].text}</div>`;
    $('bwDl').style.display = '';
  };

  window.dlBW = () => {
    if (!window._bw.resultCanvas) return;
    downloadCanvas(window._bw.resultCanvas, 'bw_' + window._bw.file.name);
  };
};

// ---- BLUR IMAGE ----
toolTemplates.blur = () => `
  <h2>Blur Image</h2>
  <p class="tool-desc">Add blur effect to your image with adjustable intensity.</p>
  ${createUploadArea('blur', 'image/*')}
  <div id="blurWorkspace" style="display:none">
    <div class="controls">
      <label>Blur Radius: <span id="blurRVal">5</span>px</label>
      <input type="range" id="blurRadius" min="1" max="50" value="5" oninput="$('blurRVal').textContent=this.value;doBlurPreview()">
      <div class="btn-group">
        <button class="btn btn-success" onclick="dlBlurred()">Download</button>
      </div>
    </div>
    <div class="preview-container active" id="blurPreview"></div>
  </div>`;

toolInit.blur = () => {
  window._blur = {};
  setupDragDrop('blurArea', 'blurInput', async files => {
    if (!files[0]) return;
    const img = await loadImage(files[0]);
    window._blur = { img, file: files[0] };
    $('blurPreview').innerHTML = `<img src="${img.src}" style="max-height:300px"><div class="preview-label">Original</div>`;
    $('blurWorkspace').style.display = '';
    window.doBlurPreview();
  });

  window.doBlurPreview = () => {
    const { img } = window._blur;
    if (!img) return;
    const r = parseInt($('blurRadius').value);
    const c = document.createElement('canvas');
    c.width = img.width; c.height = img.height;
    const ctx = c.getContext('2d');
    ctx.filter = `blur(${r}px)`;
    ctx.drawImage(img, 0, 0);
    window._blur.resultCanvas = c;
    $('blurPreview').innerHTML = `<img src="${c.toDataURL()}" style="max-height:300px"><div class="preview-label">Blur: ${r}px</div>`;
  };

  window.dlBlurred = () => {
    if (!window._blur.resultCanvas) return;
    downloadCanvas(window._blur.resultCanvas, 'blurred_' + window._blur.file.name);
  };
};

// ---- ADD WATERMARK ----
toolTemplates.watermark = () => `
  <h2>Add Watermark</h2>
  <p class="tool-desc">Add a custom text watermark to your image.</p>
  ${createUploadArea('watermark', 'image/*')}
  <div id="wmWorkspace" style="display:none">
    <div class="controls">
      <label>Watermark Text</label>
      <input type="text" id="wmText" value="Muhammad Hussain Shakir" placeholder="Enter watermark text">
      <div class="row">
        <div>
          <label>Font Size</label>
          <input type="number" id="wmSize" value="36" min="8" max="200">
        </div>
        <div>
          <label>Opacity: <span id="wmOpVal">50</span>%</label>
          <input type="range" id="wmOpacity" min="5" max="100" value="50" oninput="$('wmOpVal').textContent=this.value">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Color</label>
          <select id="wmColor">
            <option value="white">White</option>
            <option value="black">Black</option>
            <option value="red">Red</option>
            <option value="#0ea5e9">Blue</option>
          </select>
        </div>
        <div>
          <label>Position</label>
          <select id="wmPos">
            <option value="center">Center</option>
            <option value="tile">Tile (Repeat)</option>
            <option value="bottom-right">Bottom Right</option>
            <option value="bottom-left">Bottom Left</option>
            <option value="top-right">Top Right</option>
            <option value="top-left">Top Left</option>
          </select>
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="doWatermark()">Apply Watermark</button>
        <button class="btn btn-success" id="wmDl" style="display:none" onclick="dlWatermark()">Download</button>
      </div>
    </div>
    <div class="preview-container active" id="wmPreview"></div>
  </div>`;

toolInit.watermark = () => {
  window._wm = {};
  setupDragDrop('watermarkArea', 'watermarkInput', async files => {
    if (!files[0]) return;
    const img = await loadImage(files[0]);
    window._wm = { img, file: files[0] };
    $('wmPreview').innerHTML = `<img src="${img.src}" style="max-height:300px"><div class="preview-label">Original</div>`;
    $('wmWorkspace').style.display = '';
    $('wmDl').style.display = 'none';
  });

  window.doWatermark = () => {
    const { img } = window._wm;
    if (!img) return;
    const text = $('wmText').value || 'Watermark';
    const size = parseInt($('wmSize').value) || 36;
    const opacity = parseInt($('wmOpacity').value) / 100;
    const color = $('wmColor').value;
    const pos = $('wmPos').value;

    const c = document.createElement('canvas');
    c.width = img.width; c.height = img.height;
    const ctx = c.getContext('2d');
    ctx.drawImage(img, 0, 0);
    ctx.globalAlpha = opacity;
    ctx.fillStyle = color;
    ctx.font = `bold ${size}px Arial`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    if (pos === 'tile') {
      ctx.rotate(-0.3);
      const metrics = ctx.measureText(text);
      const tw = metrics.width + 60;
      const th = size + 60;
      for (let y = -c.height; y < c.height * 2; y += th) {
        for (let x = -c.width; x < c.width * 2; x += tw) {
          ctx.fillText(text, x, y);
        }
      }
    } else {
      let x, y;
      const pad = 30;
      if (pos === 'center') { x = c.width / 2; y = c.height / 2; }
      else if (pos === 'bottom-right') { x = c.width - pad; y = c.height - pad; ctx.textAlign = 'right'; }
      else if (pos === 'bottom-left') { x = pad; y = c.height - pad; ctx.textAlign = 'left'; }
      else if (pos === 'top-right') { x = c.width - pad; y = pad + size; ctx.textAlign = 'right'; }
      else if (pos === 'top-left') { x = pad; y = pad + size; ctx.textAlign = 'left'; }
      // Shadow for readability
      ctx.shadowColor = 'rgba(0,0,0,0.5)';
      ctx.shadowBlur = 4;
      ctx.shadowOffsetX = 2;
      ctx.shadowOffsetY = 2;
      ctx.fillText(text, x, y);
    }

    window._wm.resultCanvas = c;
    $('wmPreview').innerHTML = `<img src="${c.toDataURL()}" style="max-height:300px"><div class="preview-label">Watermarked</div>`;
    $('wmDl').style.display = '';
  };

  window.dlWatermark = () => {
    if (!window._wm.resultCanvas) return;
    downloadCanvas(window._wm.resultCanvas, 'watermarked_' + window._wm.file.name);
  };
};

// ---- IMAGE TO TEXT (OCR) ----
toolTemplates.ocr = () => `
  <h2>Image to Text (OCR)</h2>
  <p class="tool-desc">Extract text from images using Tesseract OCR engine.</p>
  ${createUploadArea('ocr', 'image/*')}
  <div id="ocrWorkspace" style="display:none">
    <div class="controls">
      <label>Language</label>
      <select id="ocrLang">
        <option value="eng">English</option>
        <option value="urd">Urdu</option>
        <option value="ara">Arabic</option>
        <option value="hin">Hindi</option>
        <option value="spa">Spanish</option>
        <option value="fra">French</option>
        <option value="deu">German</option>
        <option value="chi_sim">Chinese (Simplified)</option>
      </select>
      <div class="btn-group">
        <button class="btn btn-primary" id="ocrBtn" onclick="doOCR()">Extract Text</button>
        <button class="btn btn-secondary" id="ocrCopy" style="display:none" onclick="copyOCR()">Copy Text</button>
      </div>
    </div>
    <div class="loading" id="ocrLoading"><span class="spinner"></span>Extracting text... This may take a moment.</div>
    <div class="preview-container active" id="ocrImgPreview"></div>
    <div class="ocr-result" id="ocrResult"></div>
  </div>`;

toolInit.ocr = () => {
  window._ocr = {};
  setupDragDrop('ocrArea', 'ocrInput', async files => {
    if (!files[0]) return;
    const img = await loadImage(files[0]);
    window._ocr = { img, file: files[0] };
    $('ocrImgPreview').innerHTML = `<img src="${img.src}" style="max-height:250px">`;
    $('ocrWorkspace').style.display = '';
    $('ocrResult').classList.remove('active');
    $('ocrCopy').style.display = 'none';
  });

  window.doOCR = async () => {
    const { file } = window._ocr;
    if (!file) return;
    $('ocrBtn').disabled = true;
    $('ocrLoading').classList.add('active');
    $('ocrResult').classList.remove('active');

    try {
      const lang = $('ocrLang').value;
      const result = await Tesseract.recognize(file, lang, {
        logger: m => {
          if (m.status === 'recognizing text') {
            $('ocrLoading').innerHTML = `<span class="spinner"></span>Recognizing... ${Math.round((m.progress || 0) * 100)}%`;
          }
        }
      });
      window._ocr.text = result.data.text;
      $('ocrResult').textContent = result.data.text || '(No text detected)';
      $('ocrResult').classList.add('active');
      $('ocrCopy').style.display = '';
    } catch (err) {
      $('ocrResult').textContent = 'Error: ' + err.message;
      $('ocrResult').classList.add('active');
    }
    $('ocrBtn').disabled = false;
    $('ocrLoading').classList.remove('active');
    $('ocrLoading').innerHTML = '<span class="spinner"></span>Extracting text... This may take a moment.';
  };

  window.copyOCR = () => {
    if (window._ocr.text) {
      navigator.clipboard.writeText(window._ocr.text).then(() => {
        $('ocrCopy').textContent = 'Copied!';
        setTimeout(() => $('ocrCopy').textContent = 'Copy Text', 1500);
      });
    }
  };
};

// ---- TEXT TO IMAGE GENERATOR ----
toolTemplates.text2img = () => `
  <h2>Text to Image Generator</h2>
  <p class="tool-desc">Create a beautiful image from custom text.</p>
  <div class="controls">
    <label>Your Text</label>
    <textarea id="t2iText" rows="3" placeholder="Enter your text here...">Image Tools by Muhammad Hussain Shakir</textarea>
    <div class="row">
      <div><label>Font Size</label><input type="number" id="t2iSize" value="48" min="10" max="300"></div>
      <div><label>Width</label><input type="number" id="t2iW" value="800" min="100" max="4000"></div>
      <div><label>Height</label><input type="number" id="t2iH" value="400" min="100" max="4000"></div>
    </div>
    <div class="row">
      <div>
        <label>Text Color</label>
        <select id="t2iColor">
          <option value="#ffffff">White</option>
          <option value="#000000">Black</option>
          <option value="#0ea5e9">Blue</option>
          <option value="#ef4444">Red</option>
          <option value="#22c55e">Green</option>
          <option value="#f59e0b">Orange</option>
        </select>
      </div>
      <div>
        <label>Background</label>
        <select id="t2iBg">
          <option value="gradient1">Blue Gradient</option>
          <option value="gradient2">Purple Gradient</option>
          <option value="gradient3">Sunset Gradient</option>
          <option value="#0f172a">Dark Navy</option>
          <option value="#ffffff">White</option>
          <option value="#000000">Black</option>
          <option value="transparent">Transparent</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Font Style</label>
        <select id="t2iFont">
          <option value="Arial">Arial</option>
          <option value="Georgia">Georgia</option>
          <option value="Courier New">Courier New</option>
          <option value="Verdana">Verdana</option>
          <option value="Impact">Impact</option>
          <option value="Times New Roman">Times New Roman</option>
        </select>
      </div>
      <div>
        <label>Alignment</label>
        <select id="t2iAlign">
          <option value="center">Center</option>
          <option value="left">Left</option>
          <option value="right">Right</option>
        </select>
      </div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="doText2Img()">Generate Image</button>
      <button class="btn btn-success" id="t2iDl" style="display:none" onclick="dlText2Img()">Download</button>
    </div>
  </div>
  <div class="preview-container" id="t2iPreview"></div>`;

toolInit.text2img = () => {
  window._t2i = {};
  window.doText2Img = () => {
    const text = $('t2iText').value || 'Hello World';
    const size = parseInt($('t2iSize').value) || 48;
    const w = parseInt($('t2iW').value) || 800;
    const h = parseInt($('t2iH').value) || 400;
    const color = $('t2iColor').value;
    const bg = $('t2iBg').value;
    const font = $('t2iFont').value;
    const align = $('t2iAlign').value;

    const c = document.createElement('canvas');
    c.width = w; c.height = h;
    const ctx = c.getContext('2d');

    // Background
    if (bg === 'gradient1') {
      const g = ctx.createLinearGradient(0, 0, w, h);
      g.addColorStop(0, '#0f172a'); g.addColorStop(1, '#0ea5e9');
      ctx.fillStyle = g;
    } else if (bg === 'gradient2') {
      const g = ctx.createLinearGradient(0, 0, w, h);
      g.addColorStop(0, '#4c1d95'); g.addColorStop(1, '#ec4899');
      ctx.fillStyle = g;
    } else if (bg === 'gradient3') {
      const g = ctx.createLinearGradient(0, 0, w, h);
      g.addColorStop(0, '#f59e0b'); g.addColorStop(1, '#ef4444');
      ctx.fillStyle = g;
    } else if (bg !== 'transparent') {
      ctx.fillStyle = bg;
    }
    if (bg !== 'transparent') ctx.fillRect(0, 0, w, h);

    // Text
    ctx.fillStyle = color;
    ctx.font = `bold ${size}px ${font}`;
    ctx.textAlign = align;
    ctx.textBaseline = 'middle';

    const x = align === 'center' ? w / 2 : align === 'left' ? 40 : w - 40;
    const lines = text.split('\n');
    const lineH = size * 1.3;
    const startY = h / 2 - (lines.length - 1) * lineH / 2;

    lines.forEach((line, i) => {
      ctx.fillText(line, x, startY + i * lineH);
    });

    window._t2i.canvas = c;
    $('t2iPreview').innerHTML = `<img src="${c.toDataURL()}" style="max-width:100%;border-radius:8px;border:1px solid #e5e7eb">`;
    $('t2iPreview').classList.add('active');
    $('t2iDl').style.display = '';
  };

  window.dlText2Img = () => {
    if (!window._t2i.canvas) return;
    downloadCanvas(window._t2i.canvas, 'text_image.png');
  };
};

// ---- BULK IMAGE RESIZER ----
toolTemplates.bulkresize = () => `
  <h2>Bulk Image Resizer</h2>
  <p class="tool-desc">Resize multiple images at once to the same dimensions.</p>
  ${createUploadArea('bulkresize', 'image/*', true)}
  <div id="bulkWorkspace" style="display:none">
    <div class="bulk-list" id="bulkList"></div>
    <div class="controls">
      <div class="row">
        <div><label>Width (px)</label><input type="number" id="bulkW" value="800" min="1" max="10000"></div>
        <div><label>Height (px)</label><input type="number" id="bulkH" value="600" min="1" max="10000"></div>
      </div>
      <label><input type="checkbox" id="bulkLock" checked> Maintain aspect ratio (use width as reference)</label>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="doBulkResize()">Resize All</button>
      </div>
    </div>
    <div class="loading" id="bulkLoading"><span class="spinner"></span>Processing images...</div>
    <div class="result-info" id="bulkInfo"></div>
  </div>`;

toolInit.bulkresize = () => {
  window._bulk = { files: [] };
  setupDragDrop('bulkresizeArea', 'bulkresizeInput', files => {
    if (!files.length) return;
    window._bulk.files = Array.from(files);
    let html = '';
    Array.from(files).forEach((f, i) => {
      html += `<div class="bulk-item"><span>${i + 1}.</span><span>${f.name}</span><span style="color:#888">${formatSize(f.size)}</span></div>`;
    });
    $('bulkList').innerHTML = html;
    $('bulkWorkspace').style.display = '';
    $('bulkInfo').classList.remove('active');
  });

  window.doBulkResize = async () => {
    const files = window._bulk.files;
    if (!files.length) return;
    $('bulkLoading').classList.add('active');
    const w = parseInt($('bulkW').value);
    const h = parseInt($('bulkH').value);
    const lock = $('bulkLock').checked;
    let done = 0;

    for (const file of files) {
      const img = await loadImage(file);
      let rw = w, rh = h;
      if (lock) {
        rh = Math.round(w / (img.width / img.height));
      }
      const c = document.createElement('canvas');
      c.width = rw; c.height = rh;
      c.getContext('2d').drawImage(img, 0, 0, rw, rh);

      const ext = getExt(file.name);
      const type = ext === 'jpg' || ext === 'jpeg' ? 'image/jpeg' : ext === 'webp' ? 'image/webp' : 'image/png';
      await new Promise(resolve => {
        c.toBlob(blob => {
          downloadBlob(blob, 'resized_' + file.name);
          resolve();
        }, type, 0.92);
      });
      done++;
      $('bulkLoading').innerHTML = `<span class="spinner"></span>Processing ${done}/${files.length}...`;
    }
    $('bulkLoading').classList.remove('active');
    $('bulkLoading').innerHTML = '<span class="spinner"></span>Processing images...';
    $('bulkInfo').textContent = `All ${files.length} images resized to ${w}x${lock ? 'auto' : h} and downloaded.`;
    $('bulkInfo').classList.add('active');
  };
};

// ---- CHANGE IMAGE DPI ----
toolTemplates.dpi = () => `
  <h2>Change Image DPI</h2>
  <p class="tool-desc">Modify image DPI (dots per inch) for print or web use.</p>
  ${createUploadArea('dpi', 'image/*')}
  <div id="dpiWorkspace" style="display:none">
    <div class="preview-container active" id="dpiPreview"></div>
    <div class="controls">
      <div class="row">
        <div>
          <label>New DPI</label>
          <input type="number" id="dpiVal" value="300" min="1" max="2400">
        </div>
        <div>
          <label>Preset</label>
          <select id="dpiPreset" onchange="$('dpiVal').value=this.value">
            <option value="300">300 DPI (Print)</option>
            <option value="150">150 DPI (Medium)</option>
            <option value="72">72 DPI (Web)</option>
            <option value="96">96 DPI (Screen)</option>
            <option value="600">600 DPI (High Print)</option>
          </select>
        </div>
      </div>
      <label><input type="checkbox" id="dpiScale"> Scale image dimensions to match new DPI</label>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="doDPI()">Apply DPI</button>
        <button class="btn btn-success" id="dpiDl" style="display:none" onclick="dlDPI()">Download</button>
      </div>
    </div>
    <div class="result-info" id="dpiInfo"></div>
  </div>`;

toolInit.dpi = () => {
  window._dpi = {};
  setupDragDrop('dpiArea', 'dpiInput', async files => {
    if (!files[0]) return;
    const img = await loadImage(files[0]);
    window._dpi = { img, file: files[0] };
    $('dpiPreview').innerHTML = `<img src="${img.src}" style="max-height:250px"><div class="preview-label">${img.width} x ${img.height}</div>`;
    $('dpiWorkspace').style.display = '';
    $('dpiDl').style.display = 'none';
    $('dpiInfo').classList.remove('active');
  });

  window.doDPI = () => {
    const { img, file } = window._dpi;
    if (!img) return;
    const newDpi = parseInt($('dpiVal').value) || 300;
    const shouldScale = $('dpiScale').checked;

    let w = img.width, h = img.height;
    if (shouldScale) {
      // Assume original is 72 DPI
      const scaleFactor = newDpi / 72;
      w = Math.round(img.width * scaleFactor);
      h = Math.round(img.height * scaleFactor);
    }

    const c = document.createElement('canvas');
    c.width = w; c.height = h;
    c.getContext('2d').drawImage(img, 0, 0, w, h);

    // Encode DPI into PNG via pHYs chunk
    c.toBlob(blob => {
      blob.arrayBuffer().then(buffer => {
        const bytes = new Uint8Array(buffer);
        const ppm = Math.round(newDpi / 0.0254); // pixels per meter
        // Create pHYs chunk
        const phys = new Uint8Array(21);
        const view = new DataView(phys.buffer);
        view.setUint32(0, 9); // length
        phys[4] = 0x70; phys[5] = 0x48; phys[6] = 0x59; phys[7] = 0x73; // pHYs
        view.setUint32(8, ppm);
        view.setUint32(12, ppm);
        phys[16] = 1; // meter unit

        // CRC
        const crcData = phys.slice(4, 17);
        let crc = crc32(crcData);
        view.setUint32(17, crc);

        // Find IDAT position and insert pHYs before it
        let idatPos = -1;
        for (let i = 8; i < bytes.length - 4; i++) {
          if (bytes[i] === 0x49 && bytes[i+1] === 0x44 && bytes[i+2] === 0x41 && bytes[i+3] === 0x54) {
            idatPos = i - 4; // include length field
            break;
          }
        }

        if (idatPos > 0) {
          const result = new Uint8Array(bytes.length + phys.length);
          result.set(bytes.slice(0, idatPos));
          result.set(phys, idatPos);
          result.set(bytes.slice(idatPos), idatPos + phys.length);
          window._dpi.resultBlob = new Blob([result], { type: 'image/png' });
        } else {
          window._dpi.resultBlob = blob;
        }

        $('dpiDl').style.display = '';
        $('dpiInfo').innerHTML = `DPI set to ${newDpi}. ${shouldScale ? `Image scaled to ${w}x${h}.` : 'Dimensions unchanged.'}`;
        $('dpiInfo').classList.add('active');
        $('dpiPreview').innerHTML = `<img src="${URL.createObjectURL(window._dpi.resultBlob)}" style="max-height:250px"><div class="preview-label">${w} x ${h} @ ${newDpi} DPI</div>`;
      });
    }, 'image/png');
  };

  window.dlDPI = () => {
    if (!window._dpi.resultBlob) return;
    downloadBlob(window._dpi.resultBlob, 'dpi_' + baseName(window._dpi.file.name) + '.png');
  };
};

// CRC32 for PNG
function crc32(buf) {
  let table = window._crc32table;
  if (!table) {
    table = new Uint32Array(256);
    for (let i = 0; i < 256; i++) {
      let c = i;
      for (let j = 0; j < 8; j++) c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
      table[i] = c;
    }
    window._crc32table = table;
  }
  let crc = 0xFFFFFFFF;
  for (let i = 0; i < buf.length; i++) crc = table[(crc ^ buf[i]) & 0xFF] ^ (crc >>> 8);
  return (crc ^ 0xFFFFFFFF) >>> 0;
}

// ---- CONVERT IMAGE TO SVG ----
toolTemplates.tosvg = () => `
  <h2>Convert Image to SVG</h2>
  <p class="tool-desc">Convert your raster image into SVG format (embedded or traced).</p>
  ${createUploadArea('tosvg', 'image/*')}
  <div id="svgWorkspace" style="display:none">
    <div class="controls">
      <label>Method</label>
      <select id="svgMethod">
        <option value="embed">Embed as Base64 (preserves quality)</option>
        <option value="trace">Color Trace (vector posterize)</option>
      </select>
      <div id="svgTraceOpts" style="display:none">
        <label>Color Levels: <span id="svgLvlVal">6</span></label>
        <input type="range" id="svgLevels" min="2" max="16" value="6" oninput="$('svgLvlVal').textContent=this.value">
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="doSVG()">Convert</button>
        <button class="btn btn-success" id="svgDl" style="display:none" onclick="dlSVG()">Download SVG</button>
      </div>
    </div>
    <div class="loading" id="svgLoading"><span class="spinner"></span>Converting...</div>
    <div class="preview-container" id="svgPreview"></div>
    <div class="result-info" id="svgInfo"></div>
  </div>`;

toolInit.tosvg = () => {
  window._svg = {};
  setupDragDrop('tosvgArea', 'tosvgInput', async files => {
    if (!files[0]) return;
    const img = await loadImage(files[0]);
    window._svg = { img, file: files[0] };
    $('svgWorkspace').style.display = '';
    $('svgDl').style.display = 'none';
    $('svgInfo').classList.remove('active');
    $('svgPreview').classList.remove('active');
  });

  $('svgMethod') && document.addEventListener('change', e => {
    if (e.target.id === 'svgMethod') {
      $('svgTraceOpts').style.display = e.target.value === 'trace' ? '' : 'none';
    }
  });

  window.doSVG = () => {
    const { img, file } = window._svg;
    if (!img) return;
    const method = $('svgMethod').value;
    $('svgLoading').classList.add('active');

    if (method === 'embed') {
      const c = document.createElement('canvas');
      c.width = img.width; c.height = img.height;
      c.getContext('2d').drawImage(img, 0, 0);
      const dataUrl = c.toDataURL('image/png');
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${img.width}" height="${img.height}">
  <image href="${dataUrl}" width="${img.width}" height="${img.height}"/>
</svg>`;
      window._svg.svgContent = svg;
      $('svgPreview').innerHTML = `<img src="data:image/svg+xml;base64,${btoa(svg)}" style="max-height:300px;border:1px solid #e5e7eb;border-radius:8px">`;
      $('svgPreview').classList.add('active');
      $('svgDl').style.display = '';
      $('svgInfo').textContent = `SVG created with embedded image (${img.width}x${img.height})`;
      $('svgInfo').classList.add('active');
      $('svgLoading').classList.remove('active');
    } else {
      // Simple color trace
      setTimeout(() => {
        const levels = parseInt($('svgLevels').value) || 6;
        const scale = Math.min(1, 400 / Math.max(img.width, img.height));
        const sw = Math.round(img.width * scale);
        const sh = Math.round(img.height * scale);

        const c = document.createElement('canvas');
        c.width = sw; c.height = sh;
        const ctx = c.getContext('2d');
        ctx.drawImage(img, 0, 0, sw, sh);
        const data = ctx.getImageData(0, 0, sw, sh).data;

        // Posterize and create colored rectangles
        const step = Math.max(1, Math.round(256 / levels));
        let rects = '';
        for (let y = 0; y < sh; y++) {
          for (let x = 0; x < sw; x++) {
            const i = (y * sw + x) * 4;
            const r = Math.round(data[i] / step) * step;
            const g = Math.round(data[i+1] / step) * step;
            const b = Math.round(data[i+2] / step) * step;
            const rx = Math.round(x / scale);
            const ry = Math.round(y / scale);
            const rw = Math.round(1 / scale);
            const rh = Math.round(1 / scale);
            rects += `<rect x="${rx}" y="${ry}" width="${rw}" height="${rh}" fill="rgb(${r},${g},${b})"/>`;
          }
        }

        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${img.width}" height="${img.height}">${rects}</svg>`;
        window._svg.svgContent = svg;
        const blob = new Blob([svg], { type: 'image/svg+xml' });
        $('svgPreview').innerHTML = `<img src="${URL.createObjectURL(blob)}" style="max-height:300px;border:1px solid #e5e7eb;border-radius:8px">`;
        $('svgPreview').classList.add('active');
        $('svgDl').style.display = '';
        $('svgInfo').textContent = `SVG created with color trace (${levels} color levels). Size: ${formatSize(svg.length)}`;
        $('svgInfo').classList.add('active');
        $('svgLoading').classList.remove('active');
      }, 50);
    }
  };

  window.dlSVG = () => {
    if (!window._svg.svgContent) return;
    const blob = new Blob([window._svg.svgContent], { type: 'image/svg+xml' });
    downloadBlob(blob, baseName(window._svg.file.name) + '.svg');
  };
};
</script>

</body>
</html>
